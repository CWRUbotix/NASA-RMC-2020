#include "hardware/motor.h"

#include <cmath>

MotorType get_motor_type(boost::string_view type_str) {
  if (type_str.compare("vesc") == 0) {
    return MotorType::Vesc;
  } else if (type_str.compare("bmc") == 0) {
    return MotorType::BMC;
  } else if (type_str.compare("sbrth") == 0) {
    return MotorType::Sabertooth;
  }
  return MotorType::None;
}

Motor::Motor(ros::NodeHandle nh,MotorConfig const& config)
    : m_nh(nh), m_config(config)
{
  m_motor_data_pub = m_nh.advertise<hwctrl::MotorData>(m_config.cmd_topic, 128);
  m_update_timer = m_nh.createTimer(m_config.update_pd, &Motor::set_update_flag, this);
}

void Motor::set_setpoint(ros::Time time, float setpoint, float acceleration) {
  m_setpoint = setpoint;
  m_accel_setpoint = acceleration;
  m_last_set_time = time;
}

CanMotor::CanMotor(ros::NodeHandle nh,
                   uint32_t can_id, MotorType m_type)
    : Motor(nh, name, id, m_type, cmd_topic,c_type, update_pd, accel_setpoint, max_accel,
            max_rpm, gear_reduc, timeout),
      m_can_id(can_id) {
  m_can_tx_pub = m_nh.advertise<hwctrl::CanFrame>("can_frames_tx", 128);
  m_can_rx_sub =
      m_nh.subscribe("can_frames_rx", 128, &CanMotor::can_rx_callback, this);
}
